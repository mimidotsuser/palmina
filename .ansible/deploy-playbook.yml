---
- name: Deploy with docker-compose
  become: false
  gather_facts: no
  hosts: all
  vars:
    local_path: "{{local_workspace|default('~/matomo-analytics/')}}"
    remote_path: "{{remote_workspace|default('~/workspace/matomo-analytics/')}}"
    prod_env: "{{lookup('file',local_path+'/.env-enc')}}"
    nginx_user_group: "www-data"
    remote_files_user: {{remote_files_user|default('ubuntu')}}
    remote_files_group: {{remote_files_group|default('ubuntu)}}

  tasks:
    - name: Check if docker compose exist
      ansible.builtin.stat:
         path: "{{remote_path}}/docker-compose.yml"
      register: docker_config

    - name: Stop all existing services
      ansible.builtin.shell:
        cmd: docker-compose down
      args:
        chdir: "{{remote_path}}"
      when: docker_config.stat.exists
      ignore_errors: True

    - name: Create deployment directory if it does not exist
      ansible.builtin.file:
        path: "{{remote_path}}"
        state: directory
        mode: '0755'
        owner: "{{remote_files_user}}"
        group: "{{remote_files_group}}"
      when: docker_config.stat.exists == False

    - name: Copy new application files to deployment path
      ansible.posix.synchronize:
        src: "{{local_path}}/"
        dest: "{{remote_path}}/"
        delete: yes
        recursive: yes
        perms: no
        group: no
        owner: no
        rsync_opts:
          - "--exclude-from={{local_path}}/.rsync.ignore"

    - name: Upload environment variable
      ansible.builtin.lineinfile:
        line: "{{prod_env}}"
        path: "{{remote_path}}/.env"
        state: present
        create: yes
        mode: 0644
        regexp: '^%DB_DATABASE='
      no_log: True

    - name: Change permissions for storage folder
      shell:
          cmd: "chown {{nginx_user_group}} -R storage && chmod 0755 -R storage"
      args:
          chdir: "{{remote_path}}"
      become: True

    - name: Create symlink between storage and public folder
      shell:
          cmd: "ln -s {{remote_path}}/storage {{remote_path}}/public/storage"
      become: True

    - name: Start the docker-compose services
      shell:
        cmd: docker-compose -f docker-compose.yml up --build -d
      args:
        chdir: "{{remote_path}}"
